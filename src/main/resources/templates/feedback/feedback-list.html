<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Feedback List</title>

    <link rel="stylesheet" th:href="@{/css/FeedBack.css}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
</head>

<body class="bg-light">

<!-- HEADER -->
<div sec:authorize="!isAuthenticated()" th:replace="layout/header-default :: header-default"></div>
<div sec:authorize="hasRole('ADMIN')" th:replace="layout/header-admin :: header-admin"></div>
<div sec:authorize="hasRole('STAFF')" th:replace="layout/header-staff :: header-staff"></div>
<div sec:authorize="hasRole('CUSTOMER')" th:replace="layout/header-customer :: header-customer"></div>

<div class="container py-4">
    <h3 class="mb-3">Feedback List</h3>

    <div th:if="${msg}" class="alert alert-success" th:text="${msg}"></div>

    <!-- BỘ LỌC SORT -->
    <div class="mb-3 d-flex flex-wrap" style="gap:14px;">

        <!-- Sort by Date -->
        <select id="dateSort" class="form-select" style="min-width:150px;">
            <option value="">Sort by Date</option>
            <option value="dateDesc">Date ↓ (Newest)</option>
            <option value="dateAsc">Date ↑ (Oldest)</option>
        </select>

        <!-- Sort by Rating -->
        <select id="ratingSort" class="form-select" style="min-width:150px;">
            <option value="">Sort by Rating</option>
            <option value="ratingDesc">Rating (Descending)</option>
            <option value="ratingAsc">Rating (Ascending)</option>
        </select>
    </div>

    <!-- TABLE -->
    <table id="feedbackTable" class="table table-hover bg-white">
        <thead>
        <tr>
            <th>ID</th>
            <th>User</th>
            <th>Product</th>
            <th>Comment</th>

            <!-- CỘT RATING VALUE ẨN -->
            <th style="display:none;">RatingValue</th>

            <th>Rating</th>
            <th>Date</th>
            <th>Reply</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="fb : ${data}">
            <td th:text="${fb.feedbackId}"></td>

            <td>
                <div th:text="${fb.account?.fullName}">Full Name</div>
                <small class="text-muted" th:text="${fb.account?.email}"></small>
            </td>

            <td th:text="${fb.product?.productName}"></td>
            <td th:text="${fb.comment}"></td>

            <!-- rating số (ẩn) -->
            <td style="display:none;" th:text="${fb.rating}"></td>

            <!-- rating sao -->
            <td>
                <span th:each="i : ${#numbers.sequence(1,5)}"
                      th:text="${i <= fb.rating ? '★' : '☆'}"
                      class="star"></span>
            </td>

            <td th:text="${#temporals.format(fb.createdAt, 'dd/MM/yyyy')}"></td>

            <td>
                <a class="btn btn-sm btn-outline-primary"
                   th:href="@{|/staff/feedback/${fb.feedbackId}|}">
                    <span th:text="${fb.reply == null ? 'Add' : 'Edit'}"></span>
                </a>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<script>
    let table;

    $(document).ready(function () {

        table = $('#feedbackTable').DataTable({
            ordering: true,
            responsive: true,
            pageLength: 5,
            order: [],
            language: {
                search: "Search:",
                lengthMenu: "Show _MENU_ rows",
                info: "Showing _START_–_END_ of _TOTAL_ feedbacks",
                paginate: { previous: "Prev", next: "Next" },
                zeroRecords: "No matching feedbacks found",
                infoEmpty: "No feedbacks available"
            }
        });

        // SORT BY DATE
        $('#dateSort').change(function () {
            let value = $(this).val();

            if (value === "dateDesc") table.order([6, 'desc']).draw();
            if (value === "dateAsc")  table.order([6, 'asc']).draw();
        });

        // SORT BY RATING (THEO CỘT SỐ → INDEX = 4)
        $('#ratingSort').change(function () {
            let value = $(this).val();

            if (value === "ratingDesc") table.order([4, 'desc']).draw();
            if (value === "ratingAsc")  table.order([4, 'asc']).draw();
        });
    });
</script>

</body>
</html>
