<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Update Product</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .image-preview-item {
            position: relative;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 5px;
        }
        .image-preview-item img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
        }
        .delete-image-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            z-index: 10;
        }
    </style>
</head>
<body>
<div th:replace="layout/header-staff :: header-staff"></div>

<div class="container mt-5 mb-5">
    <div class="row">
        <div class="col-md-10 offset-md-1">

            <h2>Update Product: <span th:text="${product.productName}"></span></h2>
            <hr>

            <form th:action="@{/staff/products/edit}"
                  th:object="${product}"
                  method="post"
                  enctype="multipart/form-data">

                <input type="hidden" th:field="*{productId}" />

                <input type="hidden" id="initial-category-id" th:value="*{category.categoryId}" />

                <div class="row">
                    <div class="col-md-7">
                        <h3>1. Basic Information</h3>

                        <div class="mb-3">
                            <label for="productName" class="form-label">Product Name</label>
                            <input type="text" class="form-control" id="productName" th:field="*{productName}" required>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="price" class="form-label">Price</label>
                                <input type="number" class="form-control" id="price" th:field="*{price}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" th:field="*{status}">
                                    <option th:value="true">Published</option>
                                    <option th:value="false">Hidden</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Detailed Description</label>
                            <textarea class="form-control" id="description" rows="8" th:field="*{description}"></textarea>
                        </div>

                        <hr class="mt-4 mb-4">

                        <h3>2. Image Management</h3>
                        <div class="mb-3">
                            <label for="imageFiles" class="form-label">Add New Images (multi-select)</label>
                            <input class="form-control" type="file" id="imageFiles" name="imageFiles" multiple>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Current Images</label>
                            <div class="image-preview-container" id="image-preview-container">
                                <div th:each="img : *{images}"
                                     class="image-preview-item"
                                     th:id="'image-item-' + ${img.imageId}">
                                    <img th:src="@{${img.imageUrl}}" alt="Product Image">
                                    <button type="button"
                                            class="btn btn-danger btn-sm rounded-circle delete-image-btn"
                                            th:data-image-id="${img.imageId}">
                                        X
                                    </button>
                                </div>
                                <div th:if="${#lists.isEmpty(product.images)}" class="text-muted">
                                    This product has no images.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-5">
                        <h3>3. Classification & Specs</h3>

                        <div class="mb-3">
                            <label for="brand" class="form-label">Brand</label>
                            <select class="form-select" id="brand" name="brand.brandId">
                                <option th:each="br : ${brands}"
                                        th:value="${br.brandId}"
                                        th:text="${br.name}"
                                        th:selected="${br.brandId == product.brand.brandId}">
                                </option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" name="category.categoryId">
                                <option th:each="cat : ${categories}"
                                        th:value="${cat.categoryId}"
                                        th:text="${cat.categoryName}"
                                        th:selected="${cat.categoryId == product.category.categoryId}">
                                </option>
                            </select>
                            <div class="form-text text-danger">
                                Note: Changing the category will require re-entering all specs.
                            </div>
                        </div>

                        <div class="card bg-light">
                            <div class="card-body">
                                <h5 class="card-title">Technical Specifications</h5>
                                <div id="spec-form-container">
                                    <div class="d-flex justify-content-center">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <hr class="mt-5">
                <div class="text-end">
                    <a th:href="@{/staff/products/list}" class="btn btn-secondary me-2">Cancel</a>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    /*<![CDATA[*/

    const productId = /*[[${product.productId}]]*/ 0;
    const initialCategoryId = /*[[${product.category.categoryId}]]*/ 0;

    document.addEventListener('DOMContentLoaded', function() {

        // 1. Load saved specs on page load
        loadSpecFormForEdit(initialCategoryId, productId);

        // 2. Add listener for Category change
        const categorySelect = document.getElementById('category');
        categorySelect.addEventListener('change', function() {
            const selectedCategoryId = this.value;

            if (selectedCategoryId == initialCategoryId) {
                // If changing back to the original category, reload the edit form
                loadSpecFormForEdit(selectedCategoryId, productId);
            } else {
                // If changing to a new category, load a blank form
                loadBlankSpecForm(selectedCategoryId);
            }
        });

        // 3. Add listener for image deletion (AJAX)
        const imageContainer = document.getElementById('image-preview-container');
        imageContainer.addEventListener('click', function(event) {
            if (event.target.classList.contains('delete-image-btn')) {
                event.preventDefault();
                const button = event.target;
                const imageId = button.getAttribute('data-image-id');

                if (confirm('Are you sure you want to delete this image immediately?')) {
                    deleteImage(imageId, button);
                }
            }
        });

    });

    // Function to load pre-filled spec form (for edit)
    async function loadSpecFormForEdit(categoryId, prodId) {
        const container = document.getElementById('spec-form-container');
        container.innerHTML = '<div class="text-center spinner-border" role="status"></div>'; // Loading spinner

        try {
            const url = `/staff/products/spec-form-edit?categoryId=${categoryId}&productId=${prodId}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');

            const htmlFragment = await response.text();
            container.innerHTML = htmlFragment;
        } catch (error) {
            console.error('Error loading specs (edit):', error);
            container.innerHTML = '<div class="alert alert-danger">Could not load specifications.</div>';
        }
    }

    // Function to load blank spec form (when category changes)
    async function loadBlankSpecForm(categoryId) {
        const container = document.getElementById('spec-form-container');
        container.innerHTML = '<div class="text-center spinner-border" role="status"></div>'; // Loading spinner

        try {
            const url = `/staff/products/spec-form?categoryId=${categoryId}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');

            const htmlFragment = await response.text();
            container.innerHTML = htmlFragment;
        } catch (error) {
            console.error('Error loading specs (blank):', error);
            container.innerHTML = '<div class="alert alert-danger">Could not load specifications.</div>';
        }
    }

    // Function to delete image via AJAX
    async function deleteImage(imageId, button) {
        try {
            const url = `/staff/products/image/${imageId}`;
            const response = await fetch(url, {
                method: 'DELETE',
                headers: {
                    'Accept': 'application/json'
                    // Add CSRF token here if you use Spring Security
                }
            });

            if (response.ok) {
                // Remove the parent element (div.image-preview-item) from the DOM
                button.closest('.image-preview-item').remove();
                alert('Image deleted successfully.');
            } else {
                throw new Error('Could not delete image.');
            }
        } catch (error) {
            console.error('Error deleting image:', error);
            alert('An error occurred while deleting the image.');
        }
    }

    /*]]>*/
</script>

</body>
</html>