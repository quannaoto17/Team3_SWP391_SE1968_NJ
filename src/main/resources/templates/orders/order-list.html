<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${pageTitle ?: 'Orders'}">Orders</title>

    <link rel="stylesheet" th:href="@{/css/OrderStyle.css}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" th:if="${isStaffOrAdmin}">
</head>
<body>

<div sec:authorize="!isAuthenticated()" th:replace="~{layout/header-default :: header-default}"></div>
<div sec:authorize="hasRole('ADMIN')" th:replace="~{layout/header-admin :: header-admin}"></div>
<div sec:authorize="hasRole('STAFF')" th:replace="~{layout/header-staff :: header-staff}"></div>
<div sec:authorize="hasRole('CUSTOMER')" th:replace="~{layout/header-customer :: header-customer}"></div>

<div class="container">
    <h2 th:text="${pageTitle ?: 'Orders'}">Orders</h2>

    <div th:if="${error}" class="alert alert-danger"><p th:text="${error}"></p></div>
    <div th:if="${success}" class="alert alert-success"><p th:text="${success}"></p></div>
    <div th:if="${info}" class="alert alert-info"><p th:text="${info}"></p></div>

    <table id="orderTable" th:if="${isStaffOrAdmin}">
        <thead>
        <tr>
            <th>Order ID</th>
            <th>Customer Name</th>
            <th>Created Date</th>
            <th>Final Amount</th>
            <th>Status (State Machine)</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="order, stat : ${adminOrderList}">
            <td th:text="${order.orderId}"></td>
            <td th:text="${order.account?.fullName}"></td>
            <td th:data-order="${#dates.format(order.createdDate, 'yyyyMMdd')}"
                th:text="${#dates.format(order.createdDate, 'dd/MM/yyyy')}">
            </td>
            <td th:data-order="${order.finalAmount}"
                th:text="${#numbers.formatInteger(order.finalAmount, 1, 'COMMA')} + ' ₫'">
            </td>

            <td>
                <div th:if="${order.status == 'Pending Payment'}">
                    <span class="status-badge status-pending">Pending Payment</span>
                </div>

                <div th:if="${order.status == 'Processing'}" class="state-processing-buttons">
                    <button class="btn-action btn-process" th:data-order-id="${order.orderId}">
                        Mark Ready to Ship
                    </button>
                    <button class="btn-action btn-cancel" th:data-order-id="${order.orderId}">
                        Hủy (Refund)
                    </button>
                </div>

                <div th:if="${order.status == 'Ready to Ship'}">
                    <span class="status-badge status-ready">Ready to Ship</span>
                </div>

                <div th:if="${order.status == 'Delivering'}">
                    <span class="status-badge status-delivering">Delivering</span>
                </div>

                <div th:if="${order.status == 'Completed'}">
                    <span class="status-badge status-completed">Completed</span>
                </div>

                <div th:if="${order.status == 'Cancelled'}">
                    <span class="status-badge status-cancelled">Cancelled</span>
                    <span th:if="${order.paymentStatus == 'REFUND_PENDING'}" class="status-refund-pending">
                    (Refund Pending)
                </span>
                </div>
            </td>

            <td class="action-buttons">
                <a th:href="@{'/orders/detail/' + ${order.orderId}}" class="view-btn">View</a>
                <button type="button" class="view-btn-payment" th:data-order-id="${order.orderId}">Payment</button>
            </td>
        </tr>
        <tr th:if="${isStaffOrAdmin and (adminOrderList == null or #lists.isEmpty(adminOrderList))}">
            <td colspan="6" style="text-align: center;">No orders found.</td>
        </tr>
        </tbody>
    </table>

    <table class="customer-order-table" th:unless="${isStaffOrAdmin}">
        <thead>
        <tr>
            <th>Order ID</th>
            <th>Created Date</th>
            <th>Final Amount</th>
            <th>Status</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="order : ${customerOrders}">
            <td th:text="${order.orderId}"></td>
            <td th:text="${#dates.format(order.createdDate, 'dd/MM/yyyy')}"></td>
            <td th:text="${#numbers.formatInteger(order.finalAmount, 1, 'COMMA')} + ' ₫'"></td>
            <td>
                <span class="status-badge"
                      th:classappend="${
                        order.status == 'Pending Payment' ? 'status-pending' :
                        order.status == 'Processing' ? 'status-processing' :
                        order.status == 'Ready to Ship' ? 'status-ready' :
                        order.status == 'Delivering' ? 'status-delivering' :
                        order.status == 'Completed' ? 'status-completed' :
                        order.status == 'Cancelled' ? 'status-cancelled' : ''
                      }"
                      th:text="${order.status}">
                </span>
            </td>
            <td class="action-buttons">
                <a th:href="@{'/orders/detail/' + ${order.orderId}}" class="view-btn">View Details</a>
                <button type="button" class="view-btn-payment" th:data-order-id="${order.orderId}">Payment Info</button>
            </td>
        </tr>
        <tr th:if="${!isStaffOrAdmin and (customerOrders == null or #lists.isEmpty(customerOrders))}">
            <td colspan="5" style="text-align: center;">You have no orders.</td>
        </tr>
        </tbody>
    </table>
</div>

<div id="payment-info-modal" class="modal">
    <div class="modal-content">
        <h4>Chi Tiết Thanh Toán</h4>

        <div id="payment-info-error" class="alert alert-danger" style="display: none;"></div>

        <div id="payment-info-body">
            <div class="info-row">
                <strong>Mã giao dịch (PayOS):</strong>
                <span id="payment-gateway-id"></span>
            </div>
            <div class="info-row">
                <strong>Số tiền:</strong>
                <span id="payment-amount"></span>
            </div>
            <div class="info-row">
                <strong>Trạng thái:</strong>
                <span id="payment-status-text" class="status-badge"></span>
            </div>
            <div class="info-row">
                <strong>Thời gian tạo:</strong>
                <span id="payment-created-at"></span>
            </div>
        </div>

        <div class="modal-actions">
            <button type="button" id="btn-close-payment-modal" class="btn-modal btn-modal-cancel">Đóng</button>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js" th:if="${isStaffOrAdmin}"></script>

<script th:inline="none">
    $(document).ready(function() {

        // --- 1. KHỞI TẠO DATATABLES ---
        if (typeof $ !== 'undefined' && typeof $.fn.DataTable !== 'undefined' && $('#orderTable').length > 0) {
            var table = $('#orderTable').DataTable({
                "paging": true,
                "info": true,
                "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
                "order": [[ 2, "desc" ]], // Sắp xếp theo cột Created Date
                "columnDefs": [
                    { "orderable": false, "targets": [4, 5] } // Tắt sort cột Status và Action
                ]
            });
        }

        // --- 2. LOGIC STATE MACHINE (Nút .btn-process) ---
        $('#orderTable tbody').on('click', '.btn-process', function() {
            var $button = $(this);
            var orderId = $button.data('order-id');
            if (!confirm('Xác nhận đơn hàng #' + orderId + ' và chuyển sang "Ready to Ship"?')) return;

            $button.prop('disabled', true).text('Đang xử lý...');
            $.ajax({
                type: "POST",
                url: "/orders/mark-ready-to-ship",
                data: { orderId: orderId },
                success: function(response) {
                    alert(response.message);
                    location.reload();
                },
                error: function(xhr) {
                    alert("Lỗi: " + (xhr.responseJSON ? xhr.responseJSON.error : "Unknown error"));
                    $button.prop('disabled', false).text('Mark Ready to Ship');
                }
            });
        });

        // --- 3. ✅ MỚI: LOGIC NÚT HỦY (REFUND) ---
        $('#orderTable tbody').on('click', '.btn-cancel', function() {
            var $button = $(this);
            var orderId = $button.data('order-id');
            if (!confirm('BẠN CÓ CHẮC MUỐN HỦY ĐƠN HÀNG #' + orderId + '? \n\nCẢNH BÁO: Hành động này sẽ kích hoạt quy trình hoàn tiền cho khách.')) {
                return;
            }

            $button.prop('disabled', true).text('Đang hủy...');
            $.ajax({
                type: "POST",
                url: "/orders/staff-cancel", // Endpoint mới
                data: { orderId: orderId },
                success: function(response) {
                    alert(response.message);
                    location.reload();
                },
                error: function(xhr) {
                    alert("Lỗi: " + (xhr.responseJSON ? xhr.responseJSON.error : "Unknown error"));
                    $button.prop('disabled', false).text('Hủy (Refund)');
                }
            });
        });

        // --- 4. LOGIC VIEW PAYMENT INFO (Giữ nguyên) ---
        const paymentModal = $('#payment-info-modal');
        const paymentInfoBody = $('#payment-info-body');
        const paymentInfoError = $('#payment-info-error');
        $('body').on('click', '.view-btn-payment', function() {
            // ... (Code của bạn từ lượt trước) ...
        });
        $('#btn-close-payment-modal').on('click', function() {
            paymentModal.css('display', 'none');
        });

    });
</script>

</body>
</html>