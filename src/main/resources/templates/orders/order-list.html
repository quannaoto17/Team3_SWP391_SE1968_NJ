<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${pageTitle ?: 'Orders'}">Orders</title>
    <link rel="stylesheet" th:href="@{/css/OrderStyle.css}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
</head>
<body>

<div sec:authorize="!isAuthenticated()" th:replace="~{layout/header-default :: header-default}"></div>
<div sec:authorize="hasRole('ADMIN')" th:replace="~{layout/header-admin :: header-admin}"></div>
<div sec:authorize="hasRole('STAFF')" th:replace="~{layout/header-staff :: header-staff}"></div>
<div sec:authorize="hasRole('CUSTOMER')" th:replace="~{layout/header-customer :: header-customer}"></div>

<div class="container">

    <h2 th:text="${pageTitle ?: 'Orders'}">Orders</h2>
    <div th:if="${error}" class="alert alert-danger"><p th:text="${error}"></p></div>
    <div th:if="${success}" class="alert alert-success"><p th:text="${success}"></p></div>
    <div th:if="${info}" class="alert alert-info"><p th:text="${info}"></p></div>

    <table id="orderTable" th:if="${isStaffOrAdmin}"> <thead>
    <tr>

        <th>Order ID</th>
        <th>Phone Number</th>
        <th>Customer Name</th>
        <th>Created Date</th>
        <th>Final Amount</th>
        <th>Status</th>
        <th>Action</th>
    </tr>
    </thead>
        <tbody>
        <tr th:each="order, stat : ${adminOrderList}">

            <td th:text="${order.orderId}"></td>
            <td th:text="${order.account?.phoneNumber}"></td>
            <td th:text="${order.account?.fullName}"></td>
            <td th:data-order="${#dates.format(order.createdDate, 'yyyyMMdd')}"
                th:text="${#dates.format(order.createdDate, 'dd/MM/yyyy')}">
            </td>
            <td th:data-order="${order.finalAmount}"
                th:text="${#numbers.formatInteger(order.finalAmount, 1, 'COMMA')} + ' ₫'">
            </td>
            <td>
                <select class="status-select" th:data-order-id="${order.orderId}">
                    <option value="Pending Payment" th:selected="${order.status == 'Pending Payment'}">Pending Payment</option>
                    <option value="Processing" th:selected="${order.status == 'Processing'}">Processing</option>
                    <option value="Ready to Ship" th:selected="${order.status == 'Ready to Ship'}">Ready to Ship</option>
                    <option value="Delivering" th:selected="${order.status == 'Delivering'}">Delivering</option>
                    <option value="Completed" th:selected="${order.status == 'Completed'}">Completed</option>
                    <option value="Cancelled" th:selected="${order.status == 'Cancelled'}">Cancelled</option>
                </select>
            </td>
            <td><a th:href="@{'/orders/detail/' + ${order.orderId}}" class="view-btn">View</a></td>
        </tr>
        <tr th:if="${isStaffOrAdmin and (adminOrderList == null or #lists.isEmpty(adminOrderList))}">
            <td colspan="8" style="text-align: center;">No orders found matching your criteria.</td>
        </tr>
        </tbody>
    </table>

    <table th:unless="${isStaffOrAdmin}">
    </table>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script th:inline="none">
    $(document).ready(function() {

        // 1. Khởi tạo DataTables VỚI PAGING
        var table = $('#orderTable').DataTable({
            "paging": true,     // <-- BẬT LẠI PAGING
            "info": true,       // <-- Bật lại thông tin "Showing 1 of X"
            "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ], // Cho phép chọn số lượng entry
            "order": [[ 4, "desc" ]] // Sắp xếp mặc định theo cột Created Date (index 4)
        });

        // 2. Thêm "listener" cho sự kiện "change" trên các <select>
        // Chúng ta dùng .on() trên 'tbody' để nó hoạt động với CẢ CÁC TRANG (paging)
        $('#orderTable tbody').on('change', 'select.status-select', function() {

            var $select = $(this);
            var orderId = $select.data('order-id'); // Lấy order-id từ data-attribute
            var newStatus = $select.val(); // Lấy status mới

            // (Tùy chọn: bạn có thể thêm một icon loading nhỏ ở đây)
            $select.prop('disabled', true); // Khóa select lại trong khi gửi

            // 3. Gửi AJAX request
            $.ajax({
                type: "POST",
                url: "/orders/update-status", // Endpoint mới
                data: {
                    orderId: orderId,
                    newStatus: newStatus
                },
                success: function(response) {
                    // Thành công!
                    console.log("Updated order " + orderId + " to " + newStatus);
                    $select.prop('disabled', false); // Mở khóa select
                    // (Tùy chọn: Hiển thị 1 thông báo success nhỏ)
                },
                error: function(xhr, status, error) {
                    // Thất bại!
                    console.error("Error updating order " + orderId);
                    $select.prop('disabled', false); // Mở khóa select

                    // Hiển thị lỗi
                    alert("Error: " + xhr.responseJSON.error);

                    // (Tùy chọn: Hoàn trả <select> về giá trị cũ)
                }
            });
        });
    });
</script>

</body>
</html>